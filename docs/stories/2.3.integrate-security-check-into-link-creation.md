# Story 2.3: Integrate Security Check into Link Creation

## Status

Draft

## Story

**As a** user,
**I want** any URL I submit to be automatically checked for safety,
**so that** I can be confident I am not sharing harmful content.

## Acceptance Criteria

1. The POST `/api/shorten` endpoint is updated to call the Safe Browsing API client before generating a short code.
2. If the Safe Browsing API returns a "safe" verdict, the workflow proceeds as normal.
3. If the Safe Browsing API returns an "unsafe" verdict, the link is not created, and an error is returned.

## Tasks / Subtasks

- [ ] Update Link Creation API Endpoint (AC: 1)
  - [ ] Modify the existing `/api/shorten` endpoint handler
  - [ ] Import and utilize the Safe Browsing API client service
  - [ ] Ensure proper dependency injection or module import

- [ ] Implement Pre-Shortening Security Check (AC: 1, 2, 3)
  - [ ] Call the Safe Browsing API client with the submitted long URL
  - [ ] Await the result of the security check
  - [ ] Implement conditional logic based on the security verdict

- [ ] Handle "Safe" Verdict (AC: 2)
  - [ ] If the URL is deemed safe, proceed with short code generation
  - [ ] Continue with database storage and response generation as before
  - [ ] Log successful security checks

- [ ] Handle "Unsafe" Verdict (AC: 3)
  - [ ] If the URL is deemed unsafe, immediately stop the link creation process
  - [ ] Return an appropriate error response (e.g., 400 Bad Request or 403 Forbidden)
  - [ ] Include a clear, user-friendly message indicating the URL was blocked due to security concerns
  - [ ] Log blocked URLs for security monitoring

- [ ] Error Handling and Edge Cases
  - [ ] Handle potential errors from the Safe Browsing API client (e.g., API downtime, rate limits)
  - [ ] Implement graceful degradation if the security check fails but is not critical
  - [ ] Ensure consistent error response format for all API errors

- [ ] Unit and Integration Testing
  - [ ] Test the `/api/shorten` endpoint with safe URLs (mock Safe Browsing API response)
  - [ ] Test the `/api/shorten` endpoint with unsafe URLs (mock Safe Browsing API response)
  - [ ] Test error handling when Safe Browsing API is unavailable
  - [ ] Verify that links are not created for unsafe URLs
  - [ ] Verify correct error messages are returned for unsafe URLs

## Dev Notes

[Source: docs/prd/epic-list.md]
[Source: docs/prd/goals-and-background-context.md]
[Source: docs/stories/1.5.link-creation-api-endpoint.md]
[Source: docs/stories/2.1.safe-browsing-api-client.md]
[Source: docs/stories/2.2.implement-api-result-caching.md]

**Integration Point:**

- The security check will be integrated into the existing `POST /api/shorten` endpoint.
- This check should occur _before_ any database writes or short code generation to prevent storing malicious links.

**Flow of Logic:**

1. Receive `POST /api/shorten` request with `longUrl`.
2. Validate `longUrl` format.
3. Call `SafeBrowsingAPIClient.checkUrl(longUrl)`.
4. **IF** `checkUrl` returns `UNSAFE`:
   - Return `400 Bad Request` or `403 Forbidden` with an error message.
5. **ELSE IF** `checkUrl` returns `SAFE`:
   - Generate unique short code.
   - Store `longUrl` and `shortCode` in database.
   - Return shortened URL.

**Error Handling:**

- If the Safe Browsing API itself returns an error (e.g., 500, network issue), the system should ideally default to allowing the link creation (fail-open) but log the incident for review. This prevents the entire service from going down if the external API has issues. _However, for a security-first approach, a fail-closed strategy might be preferred, returning an error to the user if the security check cannot be completed._ The PRD implies a fail-closed approach for unsafe links, so if the security check cannot be completed, it should be treated as unsafe.

**API Response for Unsafe Links:**

```json
{
  "success": false,
  "error": {
    "code": "UNSAFE_URL_BLOCKED",
    "message": "The submitted URL was flagged as unsafe and cannot be shortened."
  }
}
```

**Dependencies:**

- `SafeBrowsingAPIClient` (from Story 2.1, including caching from Story 2.2)
- Existing `LinkCreationAPIEndpoint` (from Story 1.5)

### Testing

Testing Requirements:

- Unit tests for the modified API endpoint logic.
- Integration tests covering the full flow: request -> security check -> (safe path) -> link creation -> response.
- Integration tests covering the full flow: request -> security check -> (unsafe path) -> error response.
- Mock Safe Browsing API client to simulate safe, unsafe, and error responses.
- Verify HTTP status codes and error messages for unsafe URLs.

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-03-14 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
