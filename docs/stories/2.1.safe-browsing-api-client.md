# Story 2.1: Safe Browsing API Client

## Status

Draft

## Story

**As a** developer,
**I want** a secure client to communicate with the Google Safe Browsing API,
**so that** I can check URLs for threats.

## Acceptance Criteria

1. A backend service is created to act as a client for the Google Safe Browsing API.
2. The API key is securely managed as a server-side environment variable.
3. The service can take a URL as input and correctly format the request to the API.

## Tasks / Subtasks

- [ ] Set up Google Safe Browsing API Access (AC: 1)
  - [ ] Obtain Google Cloud Project and enable Safe Browsing API
  - [ ] Create API key with appropriate restrictions
  - [ ] Configure API key as a secure environment variable
  - [ ] Document API key management process

- [ ] Implement API Client Service (AC: 1)
  - [ ] Create a dedicated service/module for Safe Browsing API interaction
  - [ ] Use a suitable HTTP client library (e.g., `axios`, `node-fetch`)
  - [ ] Define API request and response types using TypeScript
  - [ ] Implement error handling for API calls (network issues, rate limits, etc.)
  - [ ] Add logging for API requests and responses

- [ ] Format API Requests (AC: 3)
  - [ ] Implement function to construct `threatMatches.find` request body
  - [ ] Include `client` and `clientVersion` in the request
  - [ ] Specify `threatTypes` (e.g., `MALWARE`, `SOCIAL_ENGINEERING`)
  - [ ] Specify `platformTypes` (e.g., `ANY_PLATFORM`)
  - [ ] Add `threatEntryTypes` (e.g., `URL`)
  - [ ] Ensure URL is properly encoded before sending

- [ ] Parse API Responses
  - [ ] Implement function to parse `threatMatches.find` response
  - [ ] Extract threat information (e.g., `threatType`, `platformType`)
  - [ ] Map API response to a clear internal data structure
  - [ ] Handle cases where no threats are found
  - [ ] Log API response for debugging and auditing

- [ ] Security Best Practices (AC: 2)
  - [ ] Ensure API key is never exposed client-side
  - [ ] Implement rate limiting for API calls to avoid exceeding quotas
  - [ ] Add input sanitization for URLs before sending to API
  - [ ] Implement circuit breaker pattern for API failures
  - [ ] Regularly rotate API keys

- [ ] Unit Testing
  - [ ] Test API client with mock API responses
  - [ ] Test request formatting with various URLs
  - [ ] Test response parsing for different threat scenarios
  - [ ] Test error handling (e.g., network errors, invalid API key)
  - [ ] Test environment variable loading for API key

## Dev Notes

[Source: docs/prd/epic-list.md]
[Source: docs/prd/goals-and-background-context.md]

**Google Safe Browsing API Details:**

- API Endpoint: `https://safebrowsing.googleapis.com/v4/threatMatches:find`
- Request Method: `POST`
- Authentication: API Key
- Threat Types to check: `MALWARE`, `SOCIAL_ENGINEERING`, `UNWANTED_SOFTWARE`, `POTENTIALLY_UNWANTED_APPLICATION`
- Platform Types: `ANY_PLATFORM`
- Threat Entry Types: `URL`

**Example Request Body:**

```json
{
  "client": {
    "clientId": "your-project-name",
    "clientVersion": "1.0.0"
  },
  "threatInfo": {
    "threatTypes": ["MALWARE", "SOCIAL_ENGINEERING"],
    "platformTypes": ["ANY_PLATFORM"],
    "threatEntryTypes": ["URL"],
    "threatEntries": [
      { "url": "http://malicious.example.com/" },
      { "url": "http://phishing.example.com/" }
    ]
  }
}
```

**Technical Implementation:**

- Next.js API Routes for backend service
- TypeScript for strong typing
- Environment variables for API key management (`.env.local`)
- Use `process.env.GOOGLE_SAFE_BROWSING_API_KEY`
- Consider a wrapper function for API calls to centralize logic

**Error Handling:**

- Implement custom error classes for API-related errors
- Log detailed error messages for debugging
- Graceful degradation if API is unavailable
- Return clear error messages to the calling service

**Security Considerations:**

- Never hardcode API keys
- Restrict API key usage to specific IP addresses or HTTP referrers
- Implement server-side validation of URLs before sending to Google API
- Monitor API usage for anomalies

### Testing

Testing Requirements:

- Unit tests for API client functions (request formatting, response parsing)
- Integration tests with actual Google Safe Browsing API (using a test API key and known safe/unsafe URLs)
- Mock API responses for various scenarios (threats found, no threats, API errors)
- Security tests to ensure API key is not exposed
- Performance tests for API call latency

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-03-14 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
