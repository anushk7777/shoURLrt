# Story 2.2: Implement API Result Caching

## Status

Draft

## Story

**As a** developer,
**I want** to cache results from the Safe Browsing API,
**so that** we can reduce latency and stay within the free tier.

## Acceptance Criteria

1. A caching layer (e.g., in-memory or Redis) is implemented for the API client.
2. Safe Browsing API results for a given URL are cached for a defined TTL (24 hours).
3. Subsequent requests for the same URL within the TTL period are served from the cache.

## Tasks / Subtasks

- [ ] Choose Caching Mechanism (AC: 1)
  - [ ] Evaluate in-memory cache vs. external cache (e.g., Redis, Memcached)
  - [ ] Select appropriate caching library/solution for Next.js environment
  - [ ] Document caching decision and rationale

- [ ] Implement Caching Layer (AC: 1)
  - [ ] Create a caching utility or service
  - [ ] Implement `get(key)` and `set(key, value, ttl)` methods
  - [ ] Ensure thread-safe operations for in-memory cache
  - [ ] Configure cache size limits if using in-memory

- [ ] Integrate Cache with Safe Browsing API Client (AC: 2, 3)
  - [ ] Modify Safe Browsing API client to check cache before making API call
  - [ ] If result is in cache and not expired, return cached result
  - [ ] If result is not in cache or expired, make API call and store result in cache
  - [ ] Define and configure TTL for cached results (e.g., 24 hours)
  - [ ] Handle cache invalidation scenarios

- [ ] Error Handling and Fallbacks
  - [ ] Implement graceful fallback if cache is unavailable or fails
  - [ ] Log cache hit/miss rates and errors
  - [ ] Ensure API calls are still made if caching fails

- [ ] Performance Monitoring
  - [ ] Track cache hit ratio
  - [ ] Monitor latency improvements due to caching
  - [ ] Identify potential bottlenecks in caching layer

- [ ] Unit Testing
  - [ ] Test cache `get` and `set` operations
  - [ ] Test TTL expiration logic
  - [ ] Test cache hit and miss scenarios in API client integration
  - [ ] Test error handling when cache is unavailable
  - [ ] Test concurrent access to cache

## Dev Notes

[Source: docs/prd/epic-list.md]
[Source: docs/prd/goals-and-background-context.md]

**Caching Strategy:**

- **In-memory cache:** Simple to implement for single-instance deployments, suitable for MVP.
- **External cache (e.g., Redis):** More robust for scaled deployments, but adds infrastructure complexity.
- For MVP, an in-memory cache (e.g., using `lru-cache` or a simple `Map` with TTL logic) is sufficient.

**Cache Key:**

- The cache key should be the URL being checked by the Safe Browsing API.
- Ensure consistent URL normalization for cache keys.

**Time-to-Live (TTL):**

- A TTL of 24 hours (86400 seconds) is recommended to balance freshness and API usage reduction.
- This aligns with typical Safe Browsing API data update frequencies.

**Integration with Safe Browsing Client:**

- The caching logic should wrap the actual API call.
- Pseudocode:

  ```typescript
  async function checkUrlWithSafeBrowsing(url: string): Promise<SafeBrowsingResult> {
    const cachedResult = cache.get(url);
    if (cachedResult) {
      return cachedResult;
    }

    const apiResult = await makeSafeBrowsingApiCall(url);
    cache.set(url, apiResult, TTL);
    return apiResult;
  }
  ```

**Error Handling:**

- If caching fails (e.g., Redis connection error), the system should still attempt to call the Safe Browsing API directly.
- Log caching errors without blocking the main flow.

**Performance Considerations:**

- Minimize overhead of cache operations.
- Choose an efficient data structure for in-memory cache.
- Monitor cache hit ratio to ensure effectiveness.

### Testing

Testing Requirements:

- Unit tests for cache utility (set, get, expiration).
- Integration tests for Safe Browsing client with caching enabled.
- Test scenarios: cache hit, cache miss, expired cache, cache full (if applicable).
- Mock cache failures to ensure API fallback.
- Performance tests to measure latency reduction.

## Change Log

| Date       | Version | Description            | Author       |
| ---------- | ------- | ---------------------- | ------------ |
| 2024-03-14 | 1.0     | Initial story creation | Scrum Master |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results
